<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Add Doctor - LifeLinkr</title>
    <style>
      .hidden{
        display: none;
      }
    </style>

    <%-include('../header');  -%>
        <!-- main content start -->
            <!-- content -->
            <div class="container-fluid">

                <!-- charts -->
                <div class="col-lg-12 pl-lg-0 mt-2">
                    <h4 class="primary">Add Doctor</h4>
                </div>
                <div class="chart">
                    <div class="row">

                        <div class="col-lg-12 pl-lg-2 chart-grid mt-1">
                            <!--part 1-->
                            <div class="card card_border">
                                <div class="">
                                    <div class="col-xl-12 pr-xl-2 p-heading">
                                        <h6 class="p-text">Doctor Profile</h6>
                                    </div>

                                    <div class="col-xl-12 pr-xl-2 mb-4">
                                        <form id="doctorForm" enctype="multipart/form-data" class="mt-2">
                                            <input type="hidden" name="query" id="query" value="0">
                                            <div id="errordiv"></div>
                                            <div class="row">
                                                <div class="col-xl-3 pr-xl-2">
                                                    <div class="form-group">
                                                        <label for="exampleInputEmail1" class="input__label">Code*</label>
                                                        <input type="text" class="form-control input-style"
                                                            id="code" name="code"  data-validation="required" data-error-message="Code is required"
                                                            placeholder="">
                                                    </div>
                                                </div>

                                                <div class="col-xl-3 pr-xl-2">
                                                    <div class="form-group">
                                                        <label
                                                            class="input__label">Doctor Name*</label>
                                                        <input type="text" class="form-control input-style"
                                                            id="name" name="name" data-validation="required" data-error-message="Doctor Name is required"
                                                            placeholder="">
                                                    </div>
                                                </div>

                                                <div class="col-xl-3 pr-xl-2">
                                                    <div class="form-group">
                                                        <label for="exampleInputEmail1"
                                                            class="input__label">Qualification <span data-bs-toggle="tooltip" data-bs-placement="top" title="Dr will get notification on this no"><i class="fas fa-info-circle"></i></span></label>
                                                        <input type="text" class="form-control input-style"
                                                            id="qualification" name="qualification"
                                                            placeholder="">
                                                    </div>
                                                </div>

                                                <div class="col-xl-3 pr-xl-2">
                                                  <div class="form-group">
                                                      <label for="mobile"
                                                          class="input__label">Phone <span data-bs-toggle="tooltip" data-bs-placement="top" title="Dr will get notification on this no"><i class="fas fa-info-circle"></i></span></label>
                                                      <input type="text" class="form-control input-style"
                                                          id="mobile" name="mobile"
                                                          placeholder="">
                                                  </div>
                                              </div>

                                              <div class="col-xl-3 pr-xl-2">
                                                <div class="form-group">
                                                    <label for="email"
                                                        class="input__label">Email <span data-bs-toggle="tooltip" data-bs-placement="top" title="Dr will get notification on this no"><i class="fas fa-info-circle"></i></span></label>
                                                    <input type="text" class="form-control input-style"
                                                        id="email" name="email"
                                                        placeholder="">
                                                </div>
                                            </div>

                                                <div class="col-xl-3 pr-xl-2">
                                                  <div class="form-group">
                                                      <label for="timeSlot"
                                                          class="input__label">Time Slot (min.) <span data-bs-toggle="tooltip" data-bs-placement="top" title="Dr will get notification on this no"><i class="fas fa-info-circle"></i></span></label>
                                                      <input type="number" class="form-control input-style" data-validation="required"
                                                          id="timeSlot" name="timeSlot"
                                                          placeholder="">
                                                  </div>
                                              </div>

                                                <div class="col-xl-3">
                                                    <div class="form-group">
                                                        <label for="exampleInputEmail1" class="input__label">Speciality*</label>
                                                        <select class="form-control input-style" name="speciality" id="speciality" data-validation="required" data-error-message="Speciality is required">
                                                            <option value="">Select</option>
                                                            <option value="Cardiology">Cardiology</option>
                                                            <option value="Dermatology">Dermatology</option>
                                                            <option value="Gastroenterology">Gastroenterology</option>
                                                            <option value="Neurology">Neurology</option>
                                                            <option value="Obstetrics">Obstetrics</option>
                                                            <option value="Pediatrics">Pediatrics</option>
                                                            <option value="Psychiatry">Psychiatry</option>
                                                            <option value="Radiology">Radiology</option>
                                                            <option value="Surgery">Surgery</option>
                                                            <option value="Urology">Urology</option>
                                                        </select>
                                                        
                                                    </div>
                                                </div>
												
												<div class="col-xl-3">
                                                    <div class="form-group">
                                                        <label for="exampleInputEmail1" class="input__label">Profile Image</label>
                                                        <input type="file" class="form-control input-style"
                                                            id="image" name="image">
                                                    </div>
                                                </div>

                                            <div class="col-xl-12">
                                            <h6 class="primary mt-2 fw-bold">Visit Timing</h6>

                                            <div class="col-xl-6">
                                                <div class="row">
                                                    
                                                    <div id="mon_container" class="col-md-12"> 
                                                        <div class="row">
                                                    <div class="col-md-2">
                                                        Monday
                                                        <label><input onclick="closeRow('mon')" type="checkbox" /> Close</label>
                                                    </div>
                                                    <div class="col-4">
                                                        <label for="opens-at" class="form-label">Opens at</label>
                                                        <input id="mon_open_1" type="time" class="form-control input-style">
                                                    </div>
                                                    <div class="col-4">
                                                        <label for="opens-at" class="form-label">Close at</label>
                                                        <input id="mon_close_1" type="time" class="form-control input-style">
                                                    </div>

                                                    <div class="col-2 d-flex align-items-center">
                                                        <button onclick="addnrow('mon')" type="button" class="btn btn-outline-danger remove-slot">+</button>
                                                    </div>
                                                </div>
                                                    </div>

                                                    <div id="tue_container" class="col-md-12 mt-3"> 
                                                    <div class="row">
                                                        <div class="col-md-2">
                                                            Tuesday
                                                            <label><input onclick="closeRow('tue')" type="checkbox" /> Close</label>
                                                        </div>
                                                        <div class="col-4">
                                                            <label for="opens-at" class="form-label">Opens at</label>
                                                            <input id="tue_open_1" type="time" class="form-control input-style">
                                                        </div>
                                                        <div class="col-4">
                                                            <label for="opens-at" class="form-label">Close at</label>
                                                            <input id="tue_close_1" type="time" class="form-control input-style">
                                                        </div>
    
                                                        <div class="col-2 d-flex align-items-center">
                                                            <button onclick="addnrow('tue')" type="button" class="btn btn-outline-danger remove-slot">+</button>
                                                        </div>

                                                        </div>
                                                    </div>
                                                    <div id="wed_container" class="col-md-12 mt-3"> 
                                                      <div class="row">
                                                          <div class="col-md-2">
                                                              Wednesday
                                                              <label><input onclick="closeRow('wed')" type="checkbox" /> Close</label>
                                                          </div>
                                                          <div class="col-4">
                                                              <label for="opens-at" class="form-label">Opens at</label>
                                                              <input id="wed_open_1" type="time" class="form-control input-style">
                                                          </div>
                                                          <div class="col-4">
                                                              <label for="opens-at" class="form-label">Close at</label>
                                                              <input id="wed_close_1" type="time" class="form-control input-style">
                                                          </div>
      
                                                          <div class="col-2 d-flex align-items-center">
                                                              <button onclick="addnrow('wed')" type="button" class="btn btn-outline-danger remove-slot">+</button>
                                                          </div>
  
                                                          </div>
                                                      </div>
                                                      <div id="thu_container" class="col-md-12 mt-3"> 
                                                        <div class="row">
                                                            <div class="col-md-2">
                                                                Thursday
                                                                <label><input onclick="closeRow('thu')" type="checkbox" /> Close</label>
                                                            </div>
                                                            <div class="col-4">
                                                                <label for="opens-at" class="form-label">Opens at</label>
                                                                <input id="thu_open_1" type="time" class="form-control input-style">
                                                            </div>
                                                            <div class="col-4">
                                                                <label for="opens-at" class="form-label">Close at</label>
                                                                <input id="thu_close_1" type="time" class="form-control input-style">
                                                            </div>
        
                                                            <div class="col-2 d-flex align-items-center">
                                                                <button onclick="addnrow('thu')" type="button" class="btn btn-outline-danger remove-slot">+</button>
                                                            </div>
    
                                                            </div>
                                                        </div>
                                                        <div id="fri_container" class="col-md-12 mt-3"> 
                                                          <div class="row">
                                                              <div class="col-md-2">
                                                                  Friday
                                                                  <label><input onclick="closeRow('fri')" type="checkbox" /> Close</label>
                                                              </div>
                                                              <div class="col-4">
                                                                  <label for="opens-at" class="form-label">Opens at</label>
                                                                  <input id="fri_open_1" type="time" class="form-control input-style">
                                                              </div>
                                                              <div class="col-4">
                                                                  <label for="opens-at" class="form-label">Close at</label>
                                                                  <input id="fri_close_1" type="time" class="form-control input-style">
                                                              </div>
          
                                                              <div class="col-2 d-flex align-items-center">
                                                                  <button onclick="addnrow('fri')" type="button" class="btn btn-outline-danger remove-slot">+</button>
                                                              </div>
      
                                                              </div>
                                                          </div>
                                                          <div id="sat_container" class="col-md-12 mt-3"> 
                                                            <div class="row">
                                                                <div class="col-md-2">
                                                                    Saturday
                                                                    <label><input onclick="closeRow('sat')" type="checkbox" /> Close</label>
                                                                </div>
                                                                <div class="col-4">
                                                                    <label for="opens-at" class="form-label">Opens at</label>
                                                                    <input id="sat_open_1" type="time" class="form-control input-style">
                                                                </div>
                                                                <div class="col-4">
                                                                    <label for="opens-at" class="form-label">Close at</label>
                                                                    <input id="sat_close_1" type="time" class="form-control input-style">
                                                                </div>
            
                                                                <div class="col-2 d-flex align-items-center">
                                                                    <button onclick="addnrow('sat')" type="button" class="btn btn-outline-danger remove-slot">+</button>
                                                                </div>
        
                                                                </div>
                                                            </div>
                                                            <div id="sun_container" class="col-md-12 mt-3"> 
                                                              <div class="row">
                                                                  <div class="col-md-2">
                                                                      Sunday
                                                                      <label><input onclick="closeRow('sun')" type="checkbox" /> Close</label>
                                                                  </div>
                                                                  <div class="col-4">
                                                                      <label for="opens-at" class="form-label">Opens at</label>
                                                                      <input id="sun_open_1" type="time" class="form-control input-style">
                                                                  </div>
                                                                  <div class="col-4">
                                                                      <label for="opens-at" class="form-label">Close at</label>
                                                                      <input id="sun_close_1" type="time" class="form-control input-style">
                                                                  </div>
              
                                                                  <div class="col-2 d-flex align-items-center">
                                                                      <button onclick="addnrow('sun')" type="button" class="btn btn-outline-danger remove-slot">+</button>
                                                                  </div>
          
                                                                  </div>
                                                              </div>
                                                </div>


                                            </div>

                                            </div>
                                            <div id="loadingIndicator"></div>
                                            <div class="text-right">
                                                <button type="button" onclick="updateQuery()" id="mod-btn" class="btn btn-primary btn-style mt-3 mr-3"><i class="fa-regular fa-pen-to-square"></i> Modify</button>
                                                <button type="button" onclick=" window.location.href = '/doctors'" class="btn btn-danger btn-style mt-3 mr-3"><i
                                                        class="fas fa-times"></i> Cancel</button>
                                                <button type="submit" id="sub-btn" class="btn btn-primary btn-style mt-3"><i
                                                        class="far fa-save"></i> Save</button>
                                            </div>

                                        </form>
                                    </div>

                                </div>
                            </div>
                            <!--part 1 ended-->

                        </div>
                    </div>
                </div>
                <!-- //charts -->
            </div>


            <%-include('../footer');  -%>
    <script>
      const daysMapping = {
  mon: "Monday",
  tue: "Tuesday",
  wed: "Wednesday",
  thu: "Thursday",
  fri: "Friday",
  sat: "Saturday",
  sun: "Sunday"
};
      let saveDataTime = {};
let rowCounter = 1; // Counter to track the row number
function addnrow(dayPrefix,start="",end="") {
    rowCounter++; // Increment the counter for unique IDs

    // Create a new row
    const newRow = `
        <div class="row mb-2 mt-2">
            <div class="col-md-2">
            
            </div>
            <div class="col-4">
                <label for="${dayPrefix}_open_${rowCounter}" class="form-label">Opens at</label>
                <input id="${dayPrefix}_open_${rowCounter}" value="${start}" type="time" ${start!==""?"disabled":""} class="form-control input-style">
            </div>
            <div class="col-4">
                <label for="${dayPrefix}_close_${rowCounter}" class="form-label">Closes at</label>
                <input id="${dayPrefix}_close_${rowCounter}" value="${end}" type="time" ${end!==""?"disabled":""} class="form-control input-style">
            </div>
            <div class="col-2 d-flex align-items-center">
                <button onclick="removeRow(this,'${dayPrefix}')" type="button" class="btn btn-outline-danger remove-slot">🗑</button>
            </div>
        </div>`;

    // Append the new row to the parent container
    const parentContainer = document.getElementById(`${dayPrefix}_container`);
    parentContainer.insertAdjacentHTML("beforeend", newRow);
    const inputs = parentContainer.querySelectorAll("input[type='time']");
    inputs.forEach((input) => {
      input.addEventListener("input", () => saveDayTime(dayPrefix));
    });
}

function closeRow(id){
  document.getElementById(`${id}_open_1`).closest(".col-4").classList.toggle("hidden");
  document.getElementById(`${id}_close_1`).closest(".col-4").classList.toggle("hidden");
  delete saveDataTime[daysMapping[id]];
  console.log(saveDataTime);
  
}

function saveDayTime(day) {
  const dayContainer = document.getElementById(`${day}_container`);
  const inputs = dayContainer.querySelectorAll("input[type='time']");

  // Clear the day's data and repopulate it
  saveDataTime[daysMapping[day]] = [];

  for (let i = 0; i < inputs.length; i += 2) {
    const start = inputs[i].value;
    const end = inputs[i + 1]?.value;

    if (start && end) {
      if (end <= start) {
        alert(`Invalid time range for ${day}: 'Close at' must be after 'Opens at'.`);
        return;
      }

      saveDataTime[daysMapping[day]].push({ start, end });
    }
  }

  console.log(`Updated data for ${day}:`, saveDataTime);
}


// Function to remove a specific row
function removeRow(button,dayPrefix) {
    button.closest('.row').remove();
    const parentContainer = document.getElementById(`${dayPrefix}_container`);
    const inputs = parentContainer.querySelectorAll("input[type='time']");
    console.log(inputs);
    
    inputs.forEach((input) => saveDayTime(dayPrefix));
}

// Array of day keys, corresponding to your day mapping
const days = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];

// Iterate over each day
days.forEach((day) => {
  // Select the container for the day
  const dayContainer = document.getElementById(`${day}_container`);

  if (dayContainer) {
    // Add event listeners to all time inputs
    const inputs = dayContainer.querySelectorAll("input[type='time']");
    inputs.forEach((input) => {
      input.addEventListener("input", () => saveDayTime(day));
    });
  }
});

function spliceString(str, start, deleteCount, insert = "") {
  const strArray = str.split(""); // Convert the string to an array
  strArray.splice(start, deleteCount, insert); // Perform the splice operation
  return strArray.join(""); // Join the array back into a string
}


console.log("Event listeners added for all days.");

    function updateQuery(){
       document.getElementById('query').value=1;
       $('#mod-btn').prop('disabled', true);   
       $('input, select').prop('disabled', false);
       $('#code').prop('readonly', true);
       document.getElementById('sub-btn').disabled = false;
     }
            
   if('<%= data.id %>'!==''){
       $('input, select').prop('disabled', true);
       document.getElementById('sub-btn').disabled = true;
       document.getElementById('mod-btn').disabled = false;
       document.getElementById('code').value='<%=data.code%>'
       document.getElementById('name').value='<%=data.name%>'
       document.getElementById('qualification').value='<%=data.qualification%>'
       document.getElementById('speciality').value='<%=data.speciality%>'
       document.getElementById('email').value='<%=data.email%>'
       document.getElementById('mobile').value='<%=data.mobile%>'
 
       const fetchday = async ()=>{
        const response = await fetch(`/timeTable?id=<%= data.id %>`);
        const data = await response.json();
        console.log(data);

        const days = [];
        data.dayArray.forEach(d=>{
          let str = d.dayType.slice(0, 3).toLowerCase();
          console.log(str);
          
          d.timeTable.forEach((t,i)=>{
            if(i===0){
              document.getElementById('timeSlot').value = d.slotTiming;
              document.getElementById(`${str}_open_1`).value = t.start;
              document.getElementById(`${str}_close_1`).value = t.end;
            }else{
              addnrow(str,t.start,t.end);
            }
          })
        })
        days.forEach(d=>{
          // const dayContainer = document.getElementById(`${d}_container`);
          addnrow(d);

        })
        console.log(days);
        
       }
       fetchday();

       
     }else{
     
       document.getElementById('mod-btn').disabled = true;
     }
           </script>

            <script>
                $(document).ready(function () {
                    console.log("Document is ready");
                    const formId = '#doctorForm'
                    $(formId).on('submit', function (event) {
                        event.preventDefault();
                        const { isValid, errorMessage } = validateForm(formId);
                        const errorDivId = '#errordiv';

                        if (isValid) {
                            const url = '/saveDoctor';
                            const loadingDiv = '#loadingIndicator';
                            const formData = new FormData(this);


                            for (const [key, value] of formData.entries()) {
                                console.log(key, value);
                            }
                            formData.append("timeTable", JSON.stringify(saveDataTime));

                            saveFormImg(formData, errorDivId, url, loadingDiv);
                        } else {
                            $(errorDivId).removeClass('alert-success').addClass('alert-danger').text(errorMessage).show();
                        }
                    });

                });


            </script>